upstream nextjs_app {
    server nextjs:3000;
    keepalive 64;
}

# (Other config, rate limiting, cache zones remain the same)

server {
    # (Security headers, logging, timeouts, gzip remain the same)
    
    # ----------------------------------------------------
    # 1. Next.js static files from standalone build (FIXED)
    # ----------------------------------------------------
    location /_next/static/ {
        # CRITICAL: This path must match where your Next.js standalone output 
        # is mounted in the Nginx container (e.g., via a Docker volume).
        # Assume the build output is mounted at /app_static/
        alias /app_static/.next/static/; 

        # We serve directly, so remove proxy_pass
        
        proxy_cache STATIC;
        proxy_cache_valid 200 31536000s; # Cache success responses for 1 year
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header X-Cache-Status $upstream_cache_status;
    }
    
    # ----------------------------------------------------
    # 2. Public folder assets (Proxying may be necessary if built into Next.js)
    # ----------------------------------------------------
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|css|js|woff|woff2|ttf|otf|eot)$ {
        # For simplicity and to ensure they are found, it's often easiest to proxy 
        # these to Next.js if they are in the public folder.
        proxy_pass http://nextjs_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        
        # Cache for 30 days
        proxy_cache STATIC;
        proxy_cache_valid 200 2592000s;
        add_header Cache-Control "public, max-age=2592000";
        add_header X-Cache-Status $upstream_cache_status;
    }
    
    # ----------------------------------------------------
    # 3. API routes and main application routes (CORRECT)
    # ----------------------------------------------------
    location /api/ {
        # This remains correct: proxies to Next.js for API routes
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://nextjs_app;
        # (All other proxy headers and cache control are correct)
    }
    
    location / {
        # This remains correct: proxies to Next.js for page rendering
        limit_req zone=general_limit burst=50 nodelay;
        proxy_pass http://nextjs_app;
        # (All other proxy headers and cache control are correct)
    }
    
    # (Health check and hidden files location blocks remain the same)
     # Health check

    location /health {

        access_log off;

        return 200 "healthy\n";

        add_header Content-Type text/plain;

    }

    

    # Block access to hidden files

    location ~ /\. {

        deny all;

        access_log off;

        log_not_found off;

    }
}